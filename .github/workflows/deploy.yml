name: acme申请证书自动上传到阿里云cdn

on:
  schedule:
    - cron: '0 0 1 * *'  # 每月1号上午8点执行
  workflow_dispatch:  # 允许手动触发

jobs:
  renew-and-deploy-certs:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 安装acme.sh
        run: |
          # 使用有效的默认邮箱（GitHub Actions 的 noreply 地址）
          DEFAULT_EMAIL="actions@users.noreply.github.com"
          ACME_EMAIL="${{ secrets.ACME_EMAIL }}"
          
          if [ -z "$ACME_EMAIL" ]; then
            echo "未配置 ACME_EMAIL，使用默认邮箱: $DEFAULT_EMAIL"
            ACME_EMAIL="$DEFAULT_EMAIL"
          fi
          
          curl https://get.acme.sh | sh -s email="$ACME_EMAIL" 
          echo "$HOME/.acme.sh" >> $GITHUB_PATH
          
          echo "acme.sh 安装完成，使用邮箱: $ACME_EMAIL"

      - name: 配置CA服务器
        run: |
          echo "配置使用 ZeroSSL"
          $HOME/.acme.sh/acme.sh --set-default-ca --server zerossl
          # 强制升级到最新版本
          $HOME/.acme.sh/acme.sh --upgrade --auto-upgrade
          echo "CA_SERVER=ZeroSSL" >> $GITHUB_ENV
          echo "配置完成"
          
      - name: 一次性申请所有域名的SSL证书
        env:
          Ali_Key: ${{ secrets.ALI_KEY }}
          Ali_Secret: ${{ secrets.ALI_SECRET }}
        run: |   
          # 从 secrets 读取域名配置
          CERT_DOMAINS="${{ secrets.CERT_DOMAINS }}"
          
          if [ -z "$CERT_DOMAINS" ]; then
            echo "错误: 请在 secrets 中配置 CERT_DOMAINS"
            exit 1
          fi
          
          echo "开始一次性申请所有域名的SSL证书"
          echo "域名配置: $CERT_DOMAINS"
          echo "使用 CA: ${{ env.CA_SERVER }}"
          echo ""
          
          # 将所有域名转换为 -d 参数格式
          ALL_DOMAIN_ARGS=""
          PRIMARY_DOMAIN=""
          DOMAIN_COUNT=0
          
          # 处理域名配置，支持空格和|分隔
          ALL_DOMAINS=$(echo "$CERT_DOMAINS" | sed 's/|/ /g')
          
          for domain in $ALL_DOMAINS; do
            domain=$(echo "$domain" | xargs)
            
            if [ -z "$domain" ]; then
              continue
            fi
            
            # 第一个域名作为主域名
            if [ -z "$PRIMARY_DOMAIN" ]; then
              PRIMARY_DOMAIN="$domain"
              ALL_DOMAIN_ARGS="-d $domain"
            else
              ALL_DOMAIN_ARGS="$ALL_DOMAIN_ARGS -d $domain"
            fi
            
            DOMAIN_COUNT=$((DOMAIN_COUNT + 1))
            echo "添加域名: $domain"
          done

          echo ""
          echo "========================================"
          echo "准备申请证书"
          echo "主域名: $PRIMARY_DOMAIN"
          echo "域名总数: $DOMAIN_COUNT"
          echo "完整命令参数: $ALL_DOMAIN_ARGS"
          echo "========================================"
          echo ""
          
          # 一次性申请所有域名的证书
          echo "执行证书申请命令 (使用 ZeroSSL)..."
          
          # 先尝试使用 ZeroSSL 申请
          if ~/.acme.sh/acme.sh --issue --dns dns_ali $ALL_DOMAIN_ARGS; then
            echo "✅ ZeroSSL 证书申请成功！"
            echo "CERT_SUCCESS=true" >> $GITHUB_ENV
            echo "PRIMARY_DOMAIN=$PRIMARY_DOMAIN" >> $GITHUB_ENV
          elif ~/.acme.sh/acme.sh --renew -d "$PRIMARY_DOMAIN" --force; then
            echo "✅ ZeroSSL 证书强制续期成功！"
            echo "CERT_SUCCESS=true" >> $GITHUB_ENV
            echo "PRIMARY_DOMAIN=$PRIMARY_DOMAIN" >> $GITHUB_ENV
          else
            echo ""
            echo "⚠️  ZeroSSL 申请失败，切换到 Let's Encrypt 重试..."
            echo ""
            
            # 切换到 Let's Encrypt
            ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
            echo "CA_SERVER=Let's Encrypt" >> $GITHUB_ENV
            
            # 清理可能存在的 ZeroSSL 证书缓存
            echo "清理 ZeroSSL 证书缓存..."
            for domain in $ALL_DOMAINS; do
              domain=$(echo "$domain" | xargs)
              if [ -n "$domain" ]; then
                rm -rf $HOME/.acme.sh/${domain}_ecc || true
                rm -rf $HOME/.acme.sh/${domain} || true
              fi
            done
            
            # 删除旧的账号配置，使用新的邮箱重新注册
            rm -rf $HOME/.acme.sh/ca/acme-v02.api.letsencrypt.org || true
            
            # 使用 Let's Encrypt 重新申请
            echo "使用 Let's Encrypt 申请证书..."
            if ~/.acme.sh/acme.sh --issue --dns dns_ali $ALL_DOMAIN_ARGS --force; then
              echo "✅ Let's Encrypt 证书申请成功！"
              echo "CERT_SUCCESS=true" >> $GITHUB_ENV
              echo "PRIMARY_DOMAIN=$PRIMARY_DOMAIN" >> $GITHUB_ENV
            else
              echo "❌ Let's Encrypt 证书申请也失败！"
              echo "显示详细日志："
              if [ -f "$HOME/.acme.sh/acme.sh.log" ]; then
                cat $HOME/.acme.sh/acme.sh.log | tail -100
              else
                echo "日志文件不存在"
              fi
              echo "CERT_SUCCESS=false" >> $GITHUB_ENV
              exit 1
            fi
          fi
          
      - name: 一次性上传证书到阿里云CDN
        if: env.CERT_SUCCESS == 'true'
        env:
          DEPLOY_ALI_CDN_ACCESS_KEY_ID: ${{ secrets.ALI_KEY }}
          DEPLOY_ALI_CDN_ACCESS_KEY_SECRET: ${{ secrets.ALI_SECRET }}
          DEPLOY_ALI_CDN_DOMAIN: ${{ secrets.CDN_DOMAINS }}
        run: |
          CDN_DOMAINS="${{ secrets.CDN_DOMAINS }}"
          PRIMARY_DOMAIN="${{ env.PRIMARY_DOMAIN }}"
          
          if [ -z "$CDN_DOMAINS" ]; then
            echo "错误: 请在 secrets 中配置 CDN_DOMAINS"
            exit 1
          fi
          
          if [ -z "$PRIMARY_DOMAIN" ]; then
            echo "错误: 没有找到主域名"
            exit 1
          fi
          
          echo "========================================"
          echo "开始上传证书到阿里云CDN"
          echo "主域名: $PRIMARY_DOMAIN"
          echo "CDN域名配置: $CDN_DOMAINS"
          echo "========================================"
          echo ""
          
          # 直接部署到CDN，acme.sh会自动处理证书文件
          echo "执行CDN部署命令..."
          if ~/.acme.sh/acme.sh --deploy -d "$PRIMARY_DOMAIN" --deploy-hook ali_cdn; then
            echo "✅ 证书成功上传到阿里云CDN！"
            echo "CDN_DEPLOY_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "❌ 证书上传到CDN失败！"
            echo "CDN_DEPLOY_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi
          
      - name: 检查最终状态
        if: always()
        run: |
          echo "========================================"
          echo "任务执行完成 - 最终状态检查"
          echo "========================================"
          echo ""
          echo "=== 证书列表 ==="
          ~/.acme.sh/acme.sh --list || echo "获取证书列表失败"
          echo ""
          echo "=== 环境变量检查 ==="
          echo "CERT_SUCCESS: ${{ env.CERT_SUCCESS }}"
          echo "CDN_DEPLOY_SUCCESS: ${{ env.CDN_DEPLOY_SUCCESS }}"
          echo "PRIMARY_DOMAIN: ${{ env.PRIMARY_DOMAIN }}"
          echo "CA_SERVER: ${{ env.CA_SERVER }}"

      - name: 更新README保持仓库活跃
        if: always()
        run: |
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          CERT_STATUS="${{ env.CERT_SUCCESS }}"
          CDN_STATUS="${{ env.CDN_DEPLOY_SUCCESS }}"
          CA_SERVER="${{ env.CA_SERVER }}"
          
          # 确定状态图标
          if [ "$CERT_STATUS" == "true" ] && [ "$CDN_STATUS" == "true" ]; then
            STATUS_ICON="✅"
            STATUS_TEXT="成功"
          elif [ "$CERT_STATUS" == "true" ]; then
            STATUS_ICON="⚠️"
            STATUS_TEXT="部分成功"
          else
            STATUS_ICON="❌"
            STATUS_TEXT="失败"
          fi
          
          # 创建或更新README
          cat > README.md << EOF
          # SSL证书自动化管理
          
          本项目使用 GitHub Actions 自动申请和部署 SSL 证书到阿里云 CDN。
          
          ## 最近运行状态
          
          - **状态**: $STATUS_ICON $STATUS_TEXT
          - **最后运行时间**: $TIMESTAMP (北京时间)
          - **使用CA**: ${CA_SERVER:-ZeroSSL}
          - **运行ID**: ${{ github.run_id }}
          
          ## 功能说明
      
          - 自动使用 acme.sh 申请 SSL 证书
          - 优先使用 ZeroSSL，失败时自动切换到 Let's Encrypt
          - 支持多域名一次性申请
          - 自动上传证书到阿里云 CDN
          - 每月自动运行一次
          - 支持手动触发
          
          ## 配置说明
          
          需要在仓库的 Settings > Secrets 中配置以下变量：
          
          - \`ALI_KEY\`: 阿里云 AccessKey ID
          - \`ALI_SECRET\`: 阿里云 AccessKey Secret
          - \`CERT_DOMAINS\`: 证书域名列表（空格或|分隔）
          - \`CDN_DOMAINS\`: CDN域名列表（空格分隔）
          - \`ACME_EMAIL\`: ACME 注册邮箱（可选）
          - \`WECHAT_WEBHOOK\`: 企业微信通知webhook（可选）
          
          ---
          
          *本 README 由 GitHub Actions 自动更新*
          EOF
          
          echo "README.md 已更新"
          cat README.md
                    
      - name: 提交README更改
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          
          # 检查是否有变化
          if git diff --staged --quiet; then
            echo "README.md 无变化，跳过提交"
          else
            git commit -m "docs: 更新最后运行状态 [skip ci]"
            git push
            echo "README.md 已提交并推送"
          fi
                    
      - name: 发送通知
        if: always()
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        run: |
          CERT_SUCCESS="${{ env.CERT_SUCCESS }}"
          CDN_DEPLOY_SUCCESS="${{ env.CDN_DEPLOY_SUCCESS }}"
          PRIMARY_DOMAIN="${{ env.PRIMARY_DOMAIN }}"
          JOB_STATUS="${{ job.status }}"
          CA_SERVER="${{ env.CA_SERVER }}"
          
          if [ "$JOB_STATUS" == "success" ] && [ "$CERT_SUCCESS" == "true" ] && [ "$CDN_DEPLOY_SUCCESS" == "true" ]; then
            STATUS="✅ 完全成功"
            MESSAGE="SSL证书一次性申请和CDN一次性部署全部成功"
            EMOJI="🎉"
          elif [ "$CERT_SUCCESS" == "true" ] && [ "$CDN_DEPLOY_SUCCESS" != "true" ]; then
            STATUS="⚠️ 部分成功"
            MESSAGE="SSL证书申请成功，但CDN部署失败"
            EMOJI="⚠️"
          elif [ "$CERT_SUCCESS" != "true" ]; then
            STATUS="❌ 申请失败"
            MESSAGE="SSL证书申请失败"
            EMOJI="💥"
          else
            STATUS="❌ 失败"
            MESSAGE="任务执行过程中出现未知错误"
            EMOJI="🚨"
          fi
          
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          # 构建域名信息
          DOMAIN_INFO=""
          if [ -n "$PRIMARY_DOMAIN" ]; then
            CERT_DOMAINS="${{ secrets.CERT_DOMAINS }}"
            ALL_DOMAINS=$(echo "$CERT_DOMAINS" | sed 's/|/ /g')
            DOMAIN_COUNT=$(echo $ALL_DOMAINS | wc -w)
            DOMAIN_INFO="\n- **主域名**: $PRIMARY_DOMAIN\n- **域名总数**: $DOMAIN_COUNT 个"
          fi
          
          CDN_INFO=""
          if [ -n "${{ secrets.CDN_DOMAINS }}" ]; then
            CDN_COUNT=$(echo "${{ secrets.CDN_DOMAINS }}" | wc -w)
            CDN_INFO="\n- **CDN域名数**: $CDN_COUNT 个"
          fi
          
          FULL_MESSAGE="$EMOJI **SSL证书自动化任务通知**\n\n- **状态**: $STATUS\n- **时间**: $TIMESTAMP\n- **CA**: ${CA_SERVER:-ZeroSSL}\n- **仓库**: ${{ github.repository }}$DOMAIN_INFO$CDN_INFO\n- **详情**: $MESSAGE\n- **运行ID**: ${{ github.run_id }}"
          
          # 企业微信通知
          if [ -n "$WECHAT_WEBHOOK" ]; then
            curl -X POST "$WECHAT_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "{
                \"msgtype\": \"markdown\",
                \"markdown\": {
                  \"content\": \"$FULL_MESSAGE\"
                }
              }" && echo "企业微信通知发送成功" || echo "企业微信通知发送失败"
          fi
